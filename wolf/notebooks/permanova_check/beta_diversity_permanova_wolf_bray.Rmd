---
title: "Beta Diversity PERMANOVA - Wolf data"
author: "Cameron Strachan"
date: '2019-03-20'
output:
  pdf_document: default
  html_document: default
---

```{r, warning=FALSE, message=FALSE}
library(vegan)
library(dplyr)
library(printr)
library(tidyr)
```

## Global comparison

```{r}
df_ftTable <- read.delim("feature-table.txt", comment.char = "", skip = 1, header = TRUE)

df_ftTable <- sapply(df_ftTable, as.numeric)

df_ftTable <- as.data.frame(t(df_ftTable))

df_ftTable <- df_ftTable[-1,]

df_ftTable <- df_ftTable[order(rownames(df_ftTable)), order(names(df_ftTable))]

df_dsDist <- vegdist(df_ftTable, method="bray")

df_dsMatrix <- as.matrix(df_dsDist)

df_dsTable <- as.data.frame(df_dsMatrix)
```

The dissimilarity matrix being used was creating using bray curtis dissimilarity on data that was rarefied to 14000 reads.

```{r}
# read in dissimilarity matrix as data frame
#df_dsTable <- read.table("bray_curtis_distance_matrix.tsv")

# oder the columns and rows
#df_dsTable <- df_dsTable[order(rownames(df_dsTable)), order(names(df_dsTable))]

# convert dataframe to matrix
#df_dsMatrix <- as.matrix(df_dsTable)

# convert matrix to distance object
#df_dsDist <- as.dist(df_dsMatrix)
```

The meta data contains 7 categorical variables. Note that the only remaining factor with NAs is pack, as this only applies to the animals that are kept outside (outdoor dogs and wolves).  

```{r}
# read in meta data
df_meta <- read.table("sample-metadata.tsv")

# order the rows
df_meta <- df_meta[order(rownames(df_meta)), ]

# subset meta data to those samples present in the dissimilarity matrix
df_meta_sub <- df_meta[rownames(df_meta) %in% names(df_dsTable),]

# the meta data has the following structure
summary(df_meta_sub)
```

\newpage

I believe that the number of unique comparisons is what should be used to set the number of permutations. This is what I will use.  
  
I will start by just looking at genus (human vs animal), sample site (skin vs feces) and group (human, pet dog, wolf or dog). It is well known that skin and feces harbor completely different microbiomes and it usually makes little sense to compare then.

```{r}
# carry out permanova on two factors
adonis(df_dsDist ~ Genus*Site*Group, df_meta_sub, permutations = length(df_dsDist))
```

Based on this, we can see that the sample site (skin vs feces) is even more important than genus.
  
I am going to devide the datasets up in skin and feces to analyze them seperately.

\newpage

### Feces comparisons

```{r}
# distance matrix for feces data
df_dsTable_feces <- df_dsTable[endsWith(rownames(df_dsTable), "f"), 
                               endsWith(colnames(df_dsTable), "f")]

# convert to distance object
df_dsDist_feces <- as.dist(as.matrix(df_dsTable_feces))

# subset meta data for feces comparison
df_meta_sub_feces <- subset(df_meta_sub, Site == "Feces")
```


```{r}
# carry out permanova on feces data where the meta data is complete
adonis(df_dsDist_feces ~ Genus*Group*Age*Antibiotic*Sex, 
       df_meta_sub_feces, permutations = length(df_dsDist_feces))
```

As expected, the genus (human vs canine) and the groups (human, pet dog, dog or wolf) that are most important. This is likely because they all live in quite different environments, have different diets etc. Therefore, I would only interpret this to check and confirm that antibiotics, sex or age do not have any large effects, as expected. As for the groups, the last factor in the meta data (pack) only applies to the dogs and wolfs. Therefore, I will seperate the datasets to to look at pack. Further, it only makes sense to analyze packs of dogs that have 3 or more dogs per pack. Fortunately, this leaves 3 packs with an N of 3 or 4 for each the dogs and the wolves.

\newpage

### Pack comparison

```{r}
# packs with n >= 3 
true_packs <- names(table(df_meta_sub_feces$Pack)[table(df_meta_sub_feces$Pack) >= 3])

# subset meta data feces, packs with 3 animals
df_meta_sub_feces_wolf_dog_pack <- df_meta_sub_feces[
  df_meta_sub_feces$Pack %in% true_packs, ]

# distance matrix for feces, packs with 3 animals
df_dsTable_feces_wolf_dog_pack <- df_dsTable_feces[
  rownames(df_dsTable_feces) %in% rownames(df_meta_sub_feces_wolf_dog_pack), 
  colnames(df_dsTable_feces) %in% rownames(df_meta_sub_feces_wolf_dog_pack)]

# convert matrix to distance object
df_dsDist_feces_wolf_dog <- as.dist(as.matrix(df_dsTable_feces_wolf_dog_pack))
```

```{r}
# carry out permanova with packs
adonis(df_dsDist_feces_wolf_dog ~ Group*Pack, 
       df_meta_sub_feces_wolf_dog_pack, permutations = length(df_dsDist_feces_wolf_dog))
```

It seems that the pack structure has some effect here. This seems reasonable and supports various ordinations I have looked at for the wolves, but not as much for the dogs. The interpretation is still difficult however, as we are not able to fully seperate the effect of family from pack (the family meta data was too incomplete). However, if it is true that packs of wolves are typically family members in the wild anyway, maybe it is still worth pointing out.  
  
If the above seems reasonable, I believe the next steps are to do the same with the skin microbiome and then check the homogeneity. 

\newpage

### Pairwise comparisons between groups

```{r}
set.seed(3)
df_meta_sub <- df_meta_sub %>%
  unite(Group_Site, c("Group", "Site"), remove = FALSE)

factors <- as.character(df_meta_sub$Group_Site)
x <- df_ftTable

co = combn(unique(as.character(factors)),2)
pairs = c()
F.Model =c()
R2 = c()
p.value = c()

for(elem in 1:ncol(co)){
  
  x1 = vegdist(df_ftTable[factors %in% c(co[1,elem],co[2,elem]),], method='bray')

  ad = adonis(x1 ~ factors[factors %in% c(co[1,elem],co[2,elem])], permutations = 800);
  
  pairs = c(pairs,paste(co[1,elem],'vs',co[2,elem]));
  F.Model =c(F.Model,ad$aov.tab[1,4]);
  R2 = c(R2,ad$aov.tab[1,5]);
  p.value = c(p.value,ad$aov.tab[1,6])

}

p.adjusted = p.adjust(p.value,method='bonferroni')
sig = c(rep('',length(p.adjusted)))
sig[p.adjusted <= 0.05] <-'.'
sig[p.adjusted <= 0.01] <-'*'
sig[p.adjusted <= 0.001] <-'**'
sig[p.adjusted <= 0.0001] <-'***'

pairwise_group_site = data.frame(pairs,F.Model,R2,p.value,p.adjusted,sig)
#print("Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1")

pairwise_group_site$pairs <- gsub("_", " ", pairwise_group_site$pairs)
pairwise_group_site$pairs <- gsub("Outdoor", " ", pairwise_group_site$pairs)
pairwise_group_site$pairs <- gsub("Pet", "Pet ", pairwise_group_site$pairs)

pairwise_group_site$pairs <- tolower(pairwise_group_site$pairs)

pairwise_group_site_clean <- pairwise_group_site %>%
  arrange(desc(p.adjusted)) %>%
  select(pairs, F.Model, p.adjusted)

colnames(pairwise_group_site_clean) <- c("pair", "F value", "adjusted p-value")

pairwise_group_site_clean
```


