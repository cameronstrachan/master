---
title: "Genomic Island Analysis Clean"
author: "Cameron Strachan"
date: '2019-04-04'
output:
  pdf_document: default
  html_document: default
---

```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(tidyverse)
```

### Summary

This time I took the single contig (4309680_59), because it had a ANT6 on it on my tree, and blasted it. Took the top 50 ncbi hits, added it to the rumen genomes and blast it. 

### Analysis steps

```{r, echo=FALSE, warning=FALSE, message=FALSE}
set.seed(1)

island_mapping <- read.delim("~/master/rumen/dataflow/02-blast/second_island_single_gene_mapping.txt", header=FALSE)
colnames(island_mapping) <- c("qseqid", "sseqid", "pident", "sstart", "send", "qstart", "qend", "evalue", "bitscore", "score", "qlen", "length", "sseq")

df_agsinst_RUG782 <- island_mapping %>%
  select(qseqid, sseqid, pident, sstart, send, qstart, qend, bitscore, length) %>%
  filter(sseqid == "4309680-submission.assembly_59") %>%
  mutate(nstart = if_else(sstart < send, sstart, send)) %>%
  mutate(nsend = if_else(send > sstart, send, sstart)) %>%
  ungroup() %>%
  filter(qseqid != "4309680-submission.assembly_59") %>%
  group_by(qseqid) %>%
  mutate(bitscore_sum = sum(bitscore)) %>%
  ungroup() %>%
  #filter(sstart > 110000) %>%
  group_by(qseqid, sseqid) %>%
  mutate(length_sum = sum(length)) %>%
  ungroup() %>%
  filter(length_sum > 1000) %>%
  filter(pident > 80)


df_agsinst_RUG782 <- df_agsinst_RUG782 %>%
  arrange(desc(bitscore_sum))

df_agsinst_RUG782$qseqid <- factor(df_agsinst_RUG782$qseqid, levels = unique(as.character(df_agsinst_RUG782$qseqid)))

df_agsinst_RUG782_dis <- df_agsinst_RUG782 %>%
  select(qseqid, bitscore_sum) %>%
  distinct()

df_reps_seqs <- as.data.frame(table(df_agsinst_RUG782_dis$bitscore_sum)[table(df_agsinst_RUG782_dis$bitscore_sum) > 1])

rep_seqs <- as.numeric(names(table(df_agsinst_RUG782_dis$bitscore_sum)[table(df_agsinst_RUG782_dis$bitscore_sum) > 1]))

colnames(df_reps_seqs)[1] <- "bitscore_sum"

df_agsinst_RUG782$bitscore_sum <- as.numeric(as.integer(df_agsinst_RUG782$bitscore_sum))
df_reps_seqs$bitscore_sum <- as.numeric(as.character(df_reps_seqs$bitscore_sum))

df_agsinst_RUG782_dis_reps <- df_agsinst_RUG782 %>%
  inner_join(df_reps_seqs) %>%
  select(qseqid, bitscore_sum, Freq) %>%
  distinct()

df_agsinst_RUG782 <- df_agsinst_RUG782 %>%
  filter(qseqid !=  "CP023544.1" ) %>%
  filter(qseqid !=  "CP017872.1") %>%
  filter(qseqid !=  "CP004067.1") %>%
  filter(qseqid != "CP026615.2") %>%
  filter(qseqid != "CP026614.2") %>%
  filter(qseqid != "CP021862.1") 










# 4000 bp only cuts off a single clone, so I could say top blast hits with that minimum length? could also have a PI of 80%. 

```

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.height=2, fig.width=7}
library(ggplot2)
library(ggalt)
theme_set(theme_classic())

gg <- ggplot(df_agsinst_RUG782, 
       aes(y = qseqid,
           x = nstart,
           xend = nsend)) +  
  geom_dumbbell(size = 0.5,
                size_x = 0.6, 
                size_xend = 0.6,
 aes(colour = pident, colour_x = pident, colour_xend = pident)) +
  theme_minimal() + 
  labs(x = "Mapping to RUG782_1",
       y = "") +
    theme(text = element_text(size=5)) + 
  scale_colour_gradient(low = "#CC6142", high = "#6395CC",
  space = "Lab", na.value = "grey50", guide = "colourbar",
  aesthetics = "colour")
  

plot(gg)
```

