---
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r}
library(tidyverse)
```

```{r}
df_compiled <- read.csv("~/master/rusitec/dataflow/04-exported-tables/df_forward_compiled.csv")
df_compiled$X <- NULL
```

```{r}
df_compiled <- df_compiled %>%
  filter(counts > 0) %>%
  mutate(rel_abundance = counts / non.chimeric) %>%
  filter(reactor != 'NC') %>%
  filter(time != "0") %>%
  filter(!(time == "288" & run == "48")) %>%
  
  group_by(run, time, day, treatment) %>%
  mutate(n = length(unique(sample))) %>%
  ungroup() %>%
  
  filter(n > 2) %>%
  
  group_by(sample) %>%
  mutate(total_reads = sum(counts)) %>%
  ungroup()

df_compiled$phylum <- as.character(df_compiled$phylum)  
```

```{r}
df_family <- df_compiled %>%
  
  group_by(run, time, day, treatment) %>%
  mutate(reads_group = sum(counts)) %>% 
  ungroup() %>%
  
  group_by(run, time, day, treatment, family) %>%
  mutate(reads_family_group = sum(counts)) %>%
  ungroup() %>%
  
  group_by(family) %>%
  mutate(reads_family= sum(counts)) %>%
  mutate(samples_family= length(unique(sample))) %>%
  ungroup() %>%
  
  mutate(rel_abundance_family= (reads_family_group / reads_group)*100) %>%
  select(run, time, day, treatment, family, rel_abundance_family, reads_family, samples_family) %>%
  distinct() %>%
  
  arrange(desc(reads_family)) %>%
  filter(!is.na(family))

df_family$family <- as.character(df_family$family)
fams <- unique(df_family$family)
```


```{r}
plot_list <- list()
i <- 1

for (fam in fams){

df_plot <- df_family %>%
  filter(family == fam)

plot <- ggplot() + geom_bar(
  aes(y = rel_abundance_family, x = treatment),
  data = df_plot,
  stat = "identity" 
)  + labs(x="Category" , y= "Percentage (%)")+
  theme_minimal() +
  theme(strip.text = element_text(size = 6),
          plot.title = element_text(size = 16),
          axis.text.x = element_text(angle = 90, hjust = 1, size = 14),
          axis.text.y = element_text(size = 12),
          axis.title.x = element_text(size = 16),
          axis.title.y = element_text(size = 16)) + 
  theme(legend.text=element_text(size=14)) +
  theme(legend.title=element_text(size=14)) +
  ylab("Percentage of Sample") +
  xlab("Individual Sample") +
  facet_grid(run ~ day,  scales = "free_y") +
  ggtitle(fam)
  plot_list[[i]] <- plot
  i <- i + 1
}
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=6, fig.height=6}
for (i in 1:length(plot_list)) {
  plot(plot_list[[i]])
  cat("\r\n\r\n")
}
```
