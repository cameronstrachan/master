---
title: "Untitled"
author: "Cameron Strachan"
date: '2020-04-06'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r}
library(tidyverse)
library(cowplot)
```

```{r}
df_dada2 <- read.csv("~/master/rusitec/dataflow/00-meta/dada2_stats.csv")
df_dada2$sample <- as.character(df_dada2$sample)

df_vbc_map <- read.csv("~/master/rusitec/dataflow/00-meta/vbc_sample_map.csv")
df_vbc_map$run <- as.character(df_vbc_map$run)
df_vbc_map$reactor <- as.character(df_vbc_map$reactor)
df_vbc_map$sample <- as.character(df_vbc_map$sample)
df_vbc_map$time <- as.character(df_vbc_map$time)

df_tp <- read.csv("~/master/rusitec/dataflow/00-meta/meta_TP.csv")
df_tp$time <- as.character(df_tp$time)

df_t48 <- read.csv("~/master/rusitec/dataflow/00-meta/meta_T48.csv")
df_t48$run <- '48'

df_t49 <- read.csv("~/master/rusitec/dataflow/00-meta/meta_T49.csv")
df_t49$run <- '49'

df_runs <- rbind(df_t48, df_t49)
df_runs$run <- as.character(df_runs$run)
df_runs$reactor <- as.character(df_runs$reactor)
df_runs$reactor <- as.character(df_runs$reactor)

df_meta <- inner_join(df_dada2, df_vbc_map) %>%
  left_join(df_tp) %>%
  left_join(df_runs) %>%
  separate(treatment, into=c("ph", "myco"), sep = "_") %>%
  filter(treatment != "NC") %>%
  filter(time != "0") %>%
  filter(!(run == "48" & time == "288"))

df_meta$sample <- paste("X", df_meta$sample, sep = "")
```

```{r}
row.names(df_meta) <- df_meta[,1]
df_meta$treatment <- as.character(df_meta$treatment)
selected_samples <- row.names(df_meta)
```

```{r}
df_counts <- read.csv("~/master/rusitec/dataflow/03-asv-table/forward-feature-table.txt", sep = '\t', skip = 1)
df_counts <- cbind(df_counts[,1], df_counts[,names(df_counts) %in% selected_samples])
colnames(df_counts)[1] <- "asv_id"
df_counts <- df_counts[order(df_counts$asv_id),] 

numsamples <- length(df_counts)

otumat <- as.matrix(df_counts[,2:numsamples])
rownames(otumat) <- as.data.frame(df_counts)[,1]
```

```{r}
library("phyloseq")
library("ape")
library(plyr)

# load phyloseq obect

OTU = otu_table(otumat, taxa_are_rows = TRUE)

samplesdata <- sample_data(df_meta)
physeq = phyloseq(OTU, samplesdata)
```


```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.height=4, fig.width=6}
set.seed(3)
library(ggplot2)
library(ggpubr)
library(RColorBrewer)
library(ggthemes)

#physeq_norm = transform_sample_counts(physeq, function(x) sqrt(x))

physeq_norm = transform_sample_counts(physeq, function(x) x / sum(x))

#getPalette = colorRampPalette(brewer.pal(9, "Set1"))
#colourCount = length(unique(df_phylocounts_meta$sample))
```

```{r}
library(tsnemicrobiota)


#t-SNE plot bray
set.seed(3)
t_SNE <- tsne_phyloseq(physeq_norm, distance = "bray", perplexity = 25, 
  precomputed_distance = NULL, pseudocounts = 1, verbose = 1,
  rng_seed = NULL, philr_options = list(), control = list())



tsne_plot <- plot_tsne_phyloseq(physeq_norm, t_SNE,
    color = 'treatment', title='t-SNE (bray)',shape="time") +
    geom_point(size=1.5) +
  theme_classic()

tsne_plot
```


```{r}
#t-SNE plot jsd
set.seed(3)
t_SNE <- tsne_phyloseq(physeq_norm, distance = "jsd", perplexity = 25,
  precomputed_distance = NULL, pseudocounts = 1, verbose = 1,
  rng_seed = NULL, philr_options = list(), control = list())


tsne_plot <- plot_tsne_phyloseq(physeq_norm, t_SNE,
    color = 'treatment', title='t-SNE (bray)',shape="time") +
    geom_point(size=1.5) +
  theme_classic()

tsne_plot
```

